# 12장 모든 웹 개발자가 관심을 가져야 할 핵심 웹 지표

## 12.1 웹사이트와 성능

#### 사용자가 웹사이트에 접속했을 때 기대하는 사항

1. 방문한 목적을 쉽게 달성할 수 있어야 함
2. 방문한 목적을 달성하는데 시간이 짧아야 함
3. 웹사이트에서 개인정보가 누출되는 등의 사고 없이 보안에 철저해야 함

## 12.2 핵심 웹 지표란?

구글에서 만든 지표로, 웹사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어이다

#### 핵심 웹 지표 3가지

1. 최대 콘텐츠 풀 페인트(LCP)
2. 최초 입력 지연(FID)
3. 누적 레이아웃 이동(CLS)

#### 특정 문제를 진단하는 데 사용할 수 있는 2가지 지표

1. 최초 바이트까지의 시간(TTFB)
2. 최초 콘텐츠풀 시간(FCP)

## 12.3 최대 콘텐츠 풀 페인트(LCP)

### 12.3.1 정의

페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 이미지 또는 텍스트를 렌더링하는 데 걸리는 시간을 말한다

#### 뷰포트 내부에서 '큰 이미지와 텍스트'

1. `<img>`
2. `<svb>` 내부의 `<img>`
3. poster 속성을 사용하는 `<video>`
4. url()을 통해 불러온 배경 이미지가 있는 요소
5. 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소
   - 이 블록 레벨 요소에는 `<p>`, `<div>` 등이 포함된다

이미지와 텍스트가 각각 사용자의 시점에 언제 노출됐는지를 확인하는 정확한 시점은 [W3C 문서](https://w3c.github.io/element-timing/#sec-element-timing)에 나와 있다.

### 12.3.2 의미

- 웹페이지가 로딩이 완료되어 사용자에게 노출되기까지 걸리는 시간의 기준을 `DOMCotentLoaded` 이벤트가 호출되는 시간으로 잡으면 안 된다
- `DOMCotentLoaded`는 HTML 문서를 완전히 불러오고 파싱했을 때 발생하는 이벤트로, 페이지의 document를 대상으로 일어나며 단 한 번만 호출된다. 이 이벤트는 스타일 시트, 이미지, 하위 프레임의 로딩은 기다리지 않는다.
- 사용자는 화면에 노출되는 부분만 로딩돼 있다면 사용자는 페이지 로딩이 완료되었다고 느끼기 때문에 뷰포트에 메인 콘텐츠가 화면에 완전히 전달되는 속도를 기준으로 한다.
- 따라서 사용자에게 페이지의 정보를 화면에 전달하는 속도를 객관적으로 판단하기 위한 지표로 만들어진 것이 바로 최대 콘텐츠풀 페인트이다.

### 12.3.3 예제

1. 최초에 헤더가 가장 먼저 노출됐다. 최대 콘텐츠풀 페인트(LCP)는 헤더다.
2. 바둑판 메뉴가 노출됐다. 이 영역은 헤더보다 크기 때문에 LCP는 바둑판 메뉴로 바뀌었다
3. 시간이 지나고 콘텐츠가 로딩되면서 LCP는 가운데 사진 영역으로 바뀌었다
4. 3번에 현재 LCP인 영역은 이미지 로딩이 필요한데 아직 이미지 로딩이 끝나지 않았다
5. LCP 영역 내부의 이미지 로딩이 마침내 끝나면서 LCP 지표가 기록된다

- LCP는 페이지 로딩에 따라 변화하는 지표이다. 사용자가 이용하는 디바이스의 크기에 따라 그리고 그것이 이미지와 같이 크기가 큰 리소스라면 실제로 로딩에 필요한 시간에 따라 LCP의 값이 달라질 수 있다

### 12.3.4 기준 점수

- 기준 점수를 측정하는 방법은 자바스크립트 API를 호출하는 방법과 다른 도구를 활용하는 방법(더 많이 사용)이 있다
- 해당 지표가 **2.5초 내로 응답이 오는 것**이 좋은 점수이다. 4초 이내로 응답이 온다면 보통, 그 이상이 걸리면 나쁨으로 판단한다

### 12.3.5 개선 방안

#### 텍스트는 언제나 옳다

- 가장 확실한 방법이다.
- 이미지를 최적화해도 텍스트 노출이 훨씬 더 빠르다.

#### 이미지는 어떻게 불러올 것인가?

- 이미지 노출하는 방법으론 아래와 같이 여러 가지가 있다

- `<img>`
  ```html
  <img src="lcp.jpg" ... />
  ```
  - 브라우저의 [프리로드 스캐너](https://yceffort.kr/2022/06/preload-scanner#pre-load-scanner%C3%AB%C5%BE%E2%80%A2-%C3%AB%C2%AC%C2%B4%C3%AC%C5%A0%E2%81%84%C3%AC%C5%A1%C2%B8%C3%AA%C2%B0%E2%80%A2)에 의해서 먼저 발견되어 빠르게 요청이 일어난다.
  - 프리로드 스캐너란 HTML을 파싱하는 단계를 차단하지 않고 이미지와 같이 빠르게 미리 로딩하면 좋은 리소스를 먼저 찾아 로딩하는 브라우저의 기능이다
  - HTML 파싱이 미처 완료되지 않더라도 프리로드 스캐너가 병렬적으로 리소스를 다운로드하므로 LCP 요소를 불러오기에 **적절한 방법**이다
- `<svg> 내부의 <img>`
  ```html
  <svg xmls="http://www.w3.org/1000/svg">
    <image href="lcp.jpg" />
  </svg>
  ```
  - 모든 리소스를 다 불러온 이후에 이미지를 불러온다
  - 따라서 프리로드 스캐너에 의해 발견되지 않아 병렬적으로 다운로드가 일어나지 않는다. 이는 결국 최대 LCP 점수에도 **악영향을 미쳐 권장하지 않는다**
- `<video>의 poster`
  ```html
  <video poster="lcp.jpg"></video>
  ```
  - [poster](https://developer.mozilla.org/ko/docs/Web/HTML/Element/Video)는 사용자가 video 요소를 재생하거나 탐색하기 전까지 노출되는 요소다
  - 프리로드 스캐너에 의해 조기에 발견되어 **적절한 방법**이다
  - 향후 poster가 없는 video의 경우 video를 실제로 로딩해 첫 번째 프레임을 해당 poster 리소스로 대체할 예정이기 때문에 poster를 반드시 넣어주는 것이 좋다
- `background-image`
  ```html
  <div style="backgroud-image: url(lcp.jpg)">...</div>
  ```
  - CSS에 있는 리소스는 항상 느리다. 이러한 리소스는 브라우저가 해당 리소스를 필요로 하는 DOM을 그릴 준비가 될 때까지 리소스 요청을 뒤로 미루기 때문에 **사용하지 않는 것이 좋다.**

#### 그 밖에 조심해야 할 사항

- **이미지 무손실 압축** : 이미지는 가능한 한 무손실 형식으로 압축해 최소한의 용량으로 서비스하는 것이 좋다
- **loading=lazy 주의** : loading=lazy는 리소스를 중요하지 않음으로 표시하고 필요할 때만 로드하는 전략이기 때문에 LCP의 이미지에 사용하면 로딩 속도를 늦춰서 사용하지 않는 것이 좋다
- **fadein과 같은 각종 애니메이션** : 이미지가 그냥 뜨는 것보다 fadein을 쓰면 LCP도 늦어진다
- **클라이언트에서 빌드하지 말 것** : 서버에서 빌드해온 HTML을 프리로드 스캐너가 바로 읽어서 최대 콘텐츠풀 페인트로 빠르게 가져가는 것이 최덕의 시나리오이다
- **최대 콘텐츠풀 리소스는 직접 호스팅** : 이미 연결이 맺어진 현재 출처가 아니라 완전 새로운 출처의 경우에는 네트워크 커넥션부터 다시 수행하기 때문에 권장하지 않는다
